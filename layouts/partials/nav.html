 <!-- Navigation partial -->
{{ if .Site.Menus.main }}
<nav class="main-nav">
    {{ $currentPage := . }}
    {{ $currentPageURL := $currentPage.RelPermalink }}
    {{ range sort .Site.Menus.main "Weight" }}
        {{ $menuURL := .URL }}
        {{ $isActive := false }}
        {{ $hasActiveChild := false }}
        
        <!-- Check if this menu item is active for regular items -->
        {{ if or (eq $currentPageURL $menuURL) (and (ne $menuURL "/") (hasPrefix $currentPageURL $menuURL)) }}
            {{ $isActive = true }}
        {{ end }}
        
        {{ if .HasChildren }}
            <!-- Reset for dropdown items - check if any child is active -->
            {{ $hasActiveChild = false }}
            {{ $isActive = false }}
            
            {{ range .Children }}
                {{ $childURL := .URL }}
                {{ if or (eq $currentPageURL $childURL) (and (ne $childURL "/") (hasPrefix $currentPageURL $childURL)) }}
                    {{ $hasActiveChild = true }}
                {{ end }}
            {{ end }}
            
            <div class="nav-dropdown">
                <button class="nav-link nav-dropdown-toggle{{ if $hasActiveChild }} active{{ end }}" aria-expanded="false">{{ .Name }} <i class="fas fa-chevron-down"></i></button>
                <div class="nav-dropdown-content">
                    {{ range .Children }}
                        {{ $childURL := .URL }}
                        {{ $childIsActive := false }}
                        
                        {{ if eq $currentPageURL $childURL }}
                            {{ $childIsActive = true }}
                        {{ else if and (ne $childURL "/") (hasPrefix $currentPageURL $childURL) }}
                            {{ $childIsActive = true }}
                        {{ end }}
                        
                        <a href="{{ .URL }}" class="nav-link{{ if $childIsActive }} active{{ end }}">{{ .Name }}</a>
                    {{ end }}
                </div>
            </div>
        {{ else }}
            <a href="{{ .URL }}" class="nav-link{{ if $isActive }} active{{ end }}">{{ .Name }}</a>
        {{ end }}
    {{ end }}
</nav>
{{ end }}